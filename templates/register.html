{% extends "base.html" %}
{% block title %}Kayıt Ol{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-10">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="card-title mb-4">Kayıt Formu</h2>
        <form method="POST">
          <!-- Temel Kullanıcı Bilgileri -->
          <div class="mb-3">
            <label class="form-label">Kullanıcı Adı</label>
            <input type="text" class="form-control" name="username" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Şifre</label>
            <input type="password" class="form-control" name="password" required>
            <small class="text-muted">Şifre 8 karakter ve en az 1 büyük harf, 1 küçük harf, 1 rakam içermelidir.</small>
          </div>
          
          <!-- Profil Bilgileri -->
          <div class="mb-3">
            <label class="form-label">Adınız</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Burç</label>
            <select class="form-select" name="zodiac" required>
              <option value="">Seçiniz</option>
              <option value="Koç">Koç</option>
              <option value="Boğa">Boğa</option>
              <option value="İkizler">İkizler</option>
              <option value="Yengeç">Yengeç</option>
              <option value="Aslan">Aslan</option>
              <option value="Başak">Başak</option>
              <option value="Terazi">Terazi</option>
              <option value="Akrep">Akrep</option>
              <option value="Yay">Yay</option>
              <option value="Oğlak">Oğlak</option>
              <option value="Kova">Kova</option>
              <option value="Balık">Balık</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Yaş</label>
            <input type="number" class="form-control" name="age" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Cinsiyet</label>
            <select class="form-select" name="gender" required>
              <option value="">Seçiniz</option>
              <option value="female">Kadın</option>
              <option value="male">Erkek</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Boy (cm)</label>
            <input type="number" step="0.1" class="form-control" name="height" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Kilo (kg)</label>
            <input type="number" step="0.1" class="form-control" name="weight" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Deneyim Seviyesi</label>
            <select class="form-select" name="experience_level" required>
              <option value="">Seçiniz</option>
              <option value="Beginner">Beginner</option>
              <option value="Intermediate">Intermediate</option>
              <option value="Advanced">Advanced</option>
            </select>
          </div>

          <!-- Hedefler (Structured Hedefler) -->
          <div class="mb-3">
            <label class="form-label">Hedefleriniz</label>
            <select class="form-select" name="goals" required>
              <option value="">Seçiniz</option>
              <option value="Sağlıklı Yaşam - Başlangıç">Sağlıklı Yaşam - Başlangıç</option>
              <option value="Kilo Vermek - Temel">Kilo Vermek - Temel</option>
              <option value="Kilo Vermek - İleri">Kilo Vermek - İleri</option>
              <option value="Kas Yapmak - Temel">Kas Yapmak - Temel</option>
              <option value="Kas Yapmak - İleri">Kas Yapmak - İleri</option>
              <option value="Dayanıklılık Artırma - Temel">Dayanıklılık Artırma - Temel</option>
              <option value="Dayanıklılık Artırma - İleri">Dayanıklılık Artırma - İleri</option>
              <option value="Performans Geliştirme">Performans Geliştirme</option>
              <option value="Profesyonel Sporcu Hedefleri">Profesyonel Sporcu Hedefleri</option>
            </select>
          </div>

          <!-- Sağlık ve Ek Bilgiler -->
          <h4 class="soru-metni">Sağlık ve Ek Bilgiler</h4>
          
          <!-- Kronik Hastalıklar (Checkbox Listesi) -->
          <div class="mb-3">
            <label class="form-label">Kronik Hastalıklar:</label><br>
            <p class="soru-metni">Lütfen varsa aşağıdaki kronik hastalık seçeneklerinden uygun olanları seçiniz:</p>
            <input type="checkbox" name="chronic_conditions_options" value="Diyabet"> Diyabet<br>
            <input type="checkbox" name="chronic_conditions_options" value="Hipertansiyon"> Hipertansiyon<br>
            <input type="checkbox" name="chronic_conditions_options" value="Astım"> Astım<br>
            <input type="checkbox" name="chronic_conditions_options" value="Kardiyovasküler"> Kardiyovasküler Hastalıklar<br>
            <input type="checkbox" name="chronic_conditions_options" value="Kanser"> Kanser<br>
            <input type="checkbox" name="chronic_conditions_options" value="Osteoporoz"> Osteoporoz<br>
            <input type="checkbox" name="chronic_conditions_options" value="Romatoid Artrit"> Romatoid Artrit<br>
            <input type="checkbox" name="chronic_conditions_options" value="Obezite"> Obezite<br>
            <input type="checkbox" name="chronic_conditions_options" value="Depresyon"> Depresyon<br>
            <input type="checkbox" name="chronic_conditions_options" value="Anemi"> Anemi<br>
            <input type="checkbox" name="chronic_conditions_options" value="Tiroid Bozukluğu"> Tiroid Bozukluğu<br>
            <input type="checkbox" name="chronic_conditions_options" value="Glaukom"> Glaukom<br>
            <input type="checkbox" name="chronic_conditions_options" value="Böbrek Hastalıkları"> Böbrek Hastalıkları<br>
            <input type="checkbox" name="chronic_conditions_options" value="Karaciğer Hastalıkları"> Karaciğer Hastalıkları<br>
            <input type="checkbox" name="chronic_conditions_options" value="Eklem Ağrıları"> Eklem Ağrıları<br>
            <input type="checkbox" name="chronic_conditions_options" value="Çölyak"> Çölyak<br>
			<input type="checkbox" name="chronic_conditions_options" value="Yok"> Yok<br>
          </div>
          
          <!-- Ameliyat Geçmişi (Dropdown) -->
          <div class="mb-3">
            <label class="form-label">Ameliyat Geçmişi:</label><br>
            <p class="soru-metni">Geçirmiş olduğunuz ameliyat türünü seçiniz:</p>
            <select class="form-select" name="surgery_history" required>
              <option value="">Seçiniz</option>
              <option value="Yok">Yok</option>
              <option value="Kalp Ameliyatı">Kalp Ameliyatı</option>
              <option value="Beyin Ameliyatı">Beyin Ameliyatı</option>
              <option value="Karın Ameliyatı">Karın Ameliyatı</option>
              <option value="Ortopedik Ameliyatlar">Ortopedik Ameliyatlar</option>
              <option value="Organ Nakli">Organ Nakli</option>
              <option value="Göz Ameliyatı">Göz Ameliyatı</option>
              <option value="Diş Ameliyatı">Diş Ameliyatı</option>
              <option value="Mide Ameliyatı">Mide Ameliyatı</option>
              <option value="Bağırsak Ameliyatı">Bağırsak Ameliyatı</option>
              <option value="Diğer">Diğer</option>
            </select>
          </div>
          
          <!-- İlaç Kullanımı -->
          <div class="mb-3">
            <label class="form-label">Düzenli İlaç Kullanıyor musunuz?</label><br>
            <p class="soru-metni">Lütfen ilaç kullanım durumunuzu seçiniz:</p>
            <input type="radio" name="drug_usage" value="evet" required> Evet  
            <input type="radio" name="drug_usage" value="hayır" required> Hayır
          </div>
          <div class="mb-3" id="drug_usage_options" style="display:none;">
            <label class="form-label">Kullandığınız İlaçlar:</label><br>
            <p class="soru-metni">Aşağıdaki ilaç seçeneklerinden kullandıklarınızı işaretleyiniz:</p>
            <input type="checkbox" name="drug_options" value="Ağrı Kesiciler"> Ağrı Kesiciler<br>
            <input type="checkbox" name="drug_options" value="Anti-inflamatuar"> Anti-inflamatuar<br>
            <input type="checkbox" name="drug_options" value="Antihipertansifler"> Antihipertansifler<br>
            <input type="checkbox" name="drug_options" value="Beta Blokerler"> Beta Blokerler<br>
            <input type="checkbox" name="drug_options" value="Statinler"> Statinler<br>
            <input type="checkbox" name="drug_options" value="ACE İnhibitörleri"> ACE İnhibitörleri<br>
            <input type="checkbox" name="drug_options" value="ARB'ler"> ARB'ler<br>
            <input type="checkbox" name="drug_options" value="Diyabet İlaçları"> Diyabet İlaçları<br>
            <input type="checkbox" name="drug_options" value="Kortikosteroidler"> Kortikosteroidler<br>
            <input type="checkbox" name="drug_options" value="Anksiyolitikler"> Anksiyolitikler<br>
            <input type="checkbox" name="drug_options" value="Uyku İlaçları"> Uyku İlaçları<br>
            <input type="checkbox" name="drug_options" value="Kemoterapi"> Kemoterapi<br>
            <input type="checkbox" name="drug_options" value="Diüretikler"> Diüretikler<br>
            <input type="checkbox" name="drug_options" value="Antidepresanlar"> Antidepresanlar<br>
            <input type="checkbox" name="drug_options" value="Diğer"> Diğer<br>
          </div>
          
          <!-- Supplement Kullanımı (15 seçenekli) -->
          <div class="mb-3">
            <label class="form-label">Supplement Kullanımı:</label><br>
            <p class="soru-metni">Lütfen supplement kullanımınıza ilişkin seçeneklerden birden fazlasını seçebilirsiniz:</p>
            <input type="checkbox" name="supplement_options" value="Protein Tozu"> Protein Tozu<br>
            <input type="checkbox" name="supplement_options" value="Kreatin"> Kreatin<br>
            <input type="checkbox" name="supplement_options" value="Karbonhidrat"> Karbonhidrat<br>
            <input type="checkbox" name="supplement_options" value="Vitamin D"> Vitamin D<br>
            <input type="checkbox" name="supplement_options" value="Omega-3 Balık Yağı"> Omega-3 Balık Yağı<br>
            <input type="checkbox" name="supplement_options" value="Multivitamin"> Multivitamin<br>
            <input type="checkbox" name="supplement_options" value="BCAA"> BCAA<br>
            <input type="checkbox" name="supplement_options" value="Glutamin"> Glutamin<br>
            <input type="checkbox" name="supplement_options" value="Kolajen"> Kolajen<br>
            <input type="checkbox" name="supplement_options" value="Prebiyotikler"> Prebiyotikler<br>
            <input type="checkbox" name="supplement_options" value="Probiotikler"> Probiotikler<br>
            <input type="checkbox" name="supplement_options" value="ZMA"> ZMA<br>
            <input type="checkbox" name="supplement_options" value="Beta-Alanin"> Beta-Alanin<br>
            <input type="checkbox" name="supplement_options" value="HMB"> HMB<br>
            <input type="checkbox" name="supplement_options" value="L-Carnitine"> L-Carnitine<br>
            <input type="checkbox" name="supplement_options" value="Curcumin"> Curcumin<br>
			<input type="checkbox" name="supplement_options" value="Yok"> Yok<br>
          </div>
          
          <!-- Günlük Su Miktarı (Dropdown, 10 seçenek: 500 ml'den 5 L'e kadar) -->
          <div class="mb-3">
            <label class="form-label">Günlük Su Miktarı:</label>
            <select class="form-select" name="daily_water_intake" required>
              <option value="">Seçiniz</option>
              <option value="500 ml">500 ml</option>
              <option value="1 L">1 L</option>
              <option value="1.5 L">1.5 L</option>
              <option value="2 L">2 L</option>
              <option value="2.5 L">2.5 L</option>
              <option value="3 L">3 L</option>
              <option value="3.5 L">3.5 L</option>
              <option value="4 L">4 L</option>
              <option value="4.5 L">4.5 L</option>
              <option value="5 L">5 L</option>
            </select>
          </div>
          
          <!-- Şehir / İlçe Alanları -->
          <div class="mb-3">
            <label class="form-label">Şehir</label>
            <select class="form-select" name="city" id="city-select" required>
              <option value="">Seçiniz</option>
              {% for city in cities %}
                <option value="{{ city.city_id }}">{{ city.city_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">İlçe</label>
            <select class="form-select" name="district" id="district-select" required>
              <option value="">Önce şehir seçiniz</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary w-100">Kayıt Ol</button>
          <small class="text-muted d-block mt-3" style="font-size: 0.8em;">* Akademik proje kapsamında bilgileriniz alınacaktır.</small>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Şehir seçildiğinde ilçeleri getir
  document.getElementById('city-select').addEventListener('change', function() {
    var cityId = this.value;
    var districtSelect = document.getElementById('district-select');
    districtSelect.innerHTML = '<option value="">Yükleniyor...</option>';
    if(cityId) {
      fetch('/get_districts/' + cityId)
        .then(response => response.json())
        .then(data => {
          districtSelect.innerHTML = '<option value="">Seçiniz</option>';
          data.districts.forEach(function(district) {
            var option = document.createElement('option');
            option.value = district.district_id;
            option.textContent = district.district_name;
            districtSelect.appendChild(option);
          });
        });
    }
  });

  // İlaç kullanımına bağlı seçenek listesini yönetmek
  var drugUsageRadios = document.getElementsByName('drug_usage');
  drugUsageRadios.forEach(function(radio) {
    radio.addEventListener('change', function() {
      var optionsDiv = document.getElementById('drug_usage_options');
      if(this.value === "evet") {
        optionsDiv.style.display = "block";
      } else {
        optionsDiv.style.display = "none";
      }
    });
  });

  // Form gönderilmeden önce checkbox gruplarının zorunluluk kontrolü
  document.querySelector('form').addEventListener('submit', function(e) {
    // Kronik Hastalıklar kontrolü
    var chronic = document.getElementsByName('chronic_conditions_options');
    var chronicChecked = Array.from(chronic).some(cb => cb.checked);
    if (!chronicChecked) {
      e.preventDefault();
      alert('Lütfen kronik hastalık seçeneklerinden en az birini seçiniz.');
      return;
    }
    // Supplement Kullanımı kontrolü
    var supplement = document.getElementsByName('supplement_options');
    var supplementChecked = Array.from(supplement).some(cb => cb.checked);
    if (!supplementChecked) {
      e.preventDefault();
      alert('Lütfen supplement seçeneklerinden en az birini seçiniz.');
      return;
    }
    // Eğer "Düzenli İlaç Kullanımı" evet seçili ise ilaç seçenekleri kontrolü
    var drugUsage = document.querySelector('input[name="drug_usage"]:checked');
    if (drugUsage && drugUsage.value === 'evet') {
      var drugOptions = document.getElementsByName('drug_options');
      var drugChecked = Array.from(drugOptions).some(cb => cb.checked);
      if (!drugChecked) {
        e.preventDefault();
        alert('Lütfen kullandığınız ilaç seçeneklerinden en az birini seçiniz.');
        return;
      }
    }
  });
  /* ---- "Yok" seçildiğinde diğerlerini kapat ---- */
  function makeExclusive(groupName){
    const boxes = document.getElementsByName(groupName);
    boxes.forEach(cb=>{
      if(cb.value === "Yok"){
        // "Yok" tıklandı → diğerlerini kapat
        cb.addEventListener('change', ()=>{
          if(cb.checked){
            boxes.forEach(b=>{ if(b!==cb) b.checked=false; });
          }
        });
      }else{
        // Diğer bir kutu tıklandı → "Yok"u kapat
        cb.addEventListener('change', ()=>{
          if(cb.checked){
            boxes.forEach(b=>{
              if(b.value==="Yok") b.checked=false;
            });
          }
        });
      }
    });
  }

  // Kronik hastalıklar ve supplement grupları için çağır
  makeExclusive('chronic_conditions_options');
  makeExclusive('supplement_options');
</script>
{% endblock %}
